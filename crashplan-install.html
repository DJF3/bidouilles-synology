<div class="entry-content">
			<p><strong>UPDATE</strong> – The instructions and notes on this page apply to all three versions of the package hosted on my repo: CrashPlan, CrashPlan PRO, and CrashPlan PROe.</p>
<p><a title="CrashPlan: Automatic Data Backup" href="http://gan.doubleclick.net/gan_click?lid=41000000035688872&amp;pubid=21000000000532076" target="_blank">CrashPlan</a> is a popular online backup solution which supports continuous syncing. With this your <abbr title="Network Attached Storage">NAS</abbr> can become even more resilient – it could even get stolen or destroyed and you would still have your data. Whilst you can pay a small monthly charge for a storage allocation in the Cloud, one neat feature CrashPlan offers is for individuals to collaboratively backup their important data to each other – for free! You could install CrashPlan on your laptop and have it continuously protecting your documents to your NAS, even whilst away from home.</p>
<p><img src="http://glassofdutchwine.files.wordpress.com/2012/01/crashplan-windows3.png?w=625" alt="CrashPlan-Windows" title="CrashPlan-windows" style="margin-top:10px;margin-bottom:10px;" class="alignnone size-full wp-image-4351"></p>
<p>CrashPlan is a Java application, and one that’s typically difficult to install on a NAS – therefore an obvious candidate for me to simplify into a package, given that I’ve made a few others. I tried and failed a few months ago, getting stuck at compiling the Jtux library for ARM CPUs (the Oracle Java for Embedded doesn’t come with any headers).</p>
<p>I noticed a few CrashPlan setup guides linking to my Java package, and decided to try again based on these: <a title="Kenneth Larsen's blog: HOW-TO: Using crashplan with Synology NAS" href="http://kennethlarsendk.blogspot.com/2011/03/how-to-using-crashplan-with-synology.html">Kenneth Larsen’s blog post</a>, the <a title="Technology Tutorials: How to install Crashplan on an IOMEGA Storcenter ix4-200d NAS" href="http://vincesoft.blogspot.com/2011/11/how-to-install-crashplan-on-iomega.html">Vincesoft blog article</a> for installing on ARM processor Iomega NAS units, and this <a title="Step by Step Installation of the CrashPlan Headless Client for Synology Diskstation with Marvell ARM CPUs" href="http://dl.dropbox.com/u/22632826/Step%20by%20Step%20Install%20of%20CrashPlan%20Headless%20Client%20on%20%28ARM%29%20CPU%20Synology%20Diskstation.pdf">handy PDF document</a> which is a digest of all of them, complete with download links for the additional compiled ARM libraries. I used the PowerPC binaries Christophe had compiled on his <a href="http://chreggy.fr/thegeek/2012/01/10/crashplan-sur-un-synology-powerpc-ds109/" title="Crashplan sur un Synology PowerPC DS109+" target="_blank">chreggy.fr blog</a>, so thanks go to him. I wanted make sure the package didn’t require the NAS to be bootstrapped, so I picked out the few generic binaries that were needed (<em>bash</em>, <em>nice</em> and <em>cpio</em>) directly from the <a href="http://ipkg.nslu2-linux.org/feeds/optware/" title="Optware package repository" target="_blank">Optware repo</a>.</p>
<div style="display:none;"><strong>UPDATE</strong> – For version 3.2 I also had to identify and then figure out how to compile <a href="http://www.twmacinta.com/myjava/fast_md5.php" title="Fast MD5 Implementation in Java" target="_blank">Tim Macinta’s fast MD5 library</a>, to fix the supplied <em>libmd5.so</em> on ARM systems (CrashPlan only distributes libraries for x86). I’m documenting that process here in case more libs are required in future versions. I identified it from the error message in <em>log/engine_error.log</em> and by running <em>objdump -x libmd5.so</em>. I could see that the same <em>Java_com_twmacinta_util_MD5_Transform_1native</em> function mentioned in the error was present in the x86 lib but not in my compiled <em>libmd5.so</em> from <a href="http://www.w3.org/Library/Distribution.html" title="Libwww - the W3C Protocol Library" target="_blank">W3C Libwww</a>. I took the headers from an install of OpenJDK on a regular Ubuntu desktop. I then used the Linux x86 source from the download bundle on Tim’s website – the closest match – and compiled it directly on the syno using the command line from a comment in <a href="http://www.twmacinta.com/myjava/MD5_solaris_contrib.c" title="Fast MD5 Implementation in Java (Solaris version)" target="_blank">another version</a> of that source:<br>
<code>gcc -O3 -shared -I/tmp/jdk_headers/include /tmp/fast-md5/src/lib/arch/linux_x86/MD5.c -o libmd5.so</code></div>
<p>Aside from the challenges of getting the library dependencies fixed for ARM and QorIQ PowerPC systems, there was also the matter of compliance – Code 42 Software’s EULA prohibits redistribution of their work. I had to make the syno package download CrashPlan for Linux (after the end user agrees their EULA), then I had to write my own script to extract this archive and mimic their installer, since their installer is interactive. It took a lot of slow testing, but I managed it!</p>
<p><img src="http://glassofdutchwine.files.wordpress.com/2012/01/cpproe_info.png?w=625" alt="CPPROe package info" title="CPPROe_info" style="margin-top:10px;margin-bottom:10px;" class="alignnone size-full wp-image-3158"></p>
<p>My most recent package version introduces handling of the automatic updates which Code 42 sometimes publish to the clients. This has proved to be quite a challenge to get working as testing was very laborious. I can confirm that it worked with the update from CrashPlan PRO 3.2 to 3.2.1 , and from CrashPlan 3.2.1 to 3.4.1:</p>
<p><img src="http://glassofdutchwine.files.wordpress.com/2012/01/crashplan-update-repair.png?w=625" alt="CrashPlan-update-repair" title="CrashPlan-update-repair" style="margin-top:10px;margin-bottom:10px;" class="alignnone size-full wp-image-3492"></p>
<div>&nbsp;</div>
<h3>Installation</h3>
<ul>
<li>This package is for Marvell Kirkwood, Marvell Armada 370/XP, Intel and Freescale QorIQ/PowerQUICC PowerPC CPUs only, so please <a href="http://forum.synology.com/wiki/index.php/What_kind_of_CPU_does_my_NAS_have" title="What kind of CPU does my NAS have" target="_blank">check which CPU your NAS has</a>. It will work on an unmodified NAS, no hacking or bootstrapping required. It will only work on older PowerQUICC PowerPC models that are running DSM 5.0. It is technically possible to run CrashPlan on older DSM versions, but it requires <em>chroot</em>-ing to a Debian install. Christophe from chreggy.fr has recently released <a href="http://chreggy.fr/thegeek/2012/01/10/crashplan-sur-un-synology-powerpc-ds109/" title="Crashplan sur un Synology PowerPC DS109+" target="_blank">packages to automate this</a>.</li>
<li>In the User Control Panel in DSM, <strong>enable the User Homes service</strong>.</li>
<li>Install the package directly from Package Center in DSM. In <em>Settings -&gt; Package Sources</em> add my package repository URL which is <strong><a href="http://packages.pcloadletter.co.uk" rel="nofollow">http://packages.pcloadletter.co.uk</a></strong>.</li>
<li>You will need to install either one of my <a title="Java SE Embedded package for Synology NAS" href="http://pcloadletter.co.uk/2011/08/23/java-package-for-synology/">Java SE Embedded</a> packages first (Java 6 or 7). Read the instructions on that page carefully too.</li>
<li>If you previously installed CrashPlan manually using the Synology Wiki, you can find uninstall instructions <a href="http://pcloadletter.co.uk/2012/01/30/crashplan-syno-package/comment-page-1/#comment-2396" title="Manual CrashPlan uninstall instructions">here</a>.</li>
</ul>
<div>&nbsp;</div>
<h3>Notes</h3>
<ul>
<li>The package downloads the CrashPlan installer directly from Code 42 Software, following acceptance of their EULA. I am complying with their wish that no one redistributes it.</li>
<li>CrashPlan is installed in headless mode – backup engine only. This is configured by a desktop client, but operates independently of it.</li>
<li>The engine daemon script checks the amount of system RAM and scales the Java heap size appropriately (up to the default maximum of 512MB). This can be overridden in a persistent way if you are backing up very large backup sets by editing <em>/volume1/@appstore/CrashPlan/syno_package.vars</em>. <strong>If you’re considering buying a NAS purely to use CrashPlan and intend to back up more than a few hundred GB then I strongly advise buying one of the Intel models</strong> which come with 1GB RAM and can be upgraded to 3GB very cheaply. RAM is very limited on the ARM ones. 128MB RAM on the J series means CrashPlan is running with only one fifth of the recommended heap size, so I doubt it’s viable for backing up very much at all. My DS111 has 256MB of RAM and currently backs up around 60GB with no issues. I have found that a 512MB heap was insufficient to back up more than 2TB of files on a Windows server. It kept restarting the backup engine every few minutes until I increased the heap to 1024MB.</li>
<li>As with my other syno packages, the daemon user account password is randomized when it is created using the <em>openssl</em> binary. DSM Package Center runs as the root user so my script starts the package using an <em>su</em> command. This means that you can change the password yourself and CrashPlan will still work.</li>
<li>The default location for saving friends’ backups is set to <em>/volume1/crashplan/backupArchives</em> (where <em>/volume1</em> is you primary storage volume) to eliminate the chance of them being destroyed accidentally by uninstalling the package.</li>
<li><strong>The first time you run the server you will need to stop it and restart it</strong> before you can connect the client. This is because a config file that’s only created on first run needs to be edited by one of my scripts. The engine is then configured to listen on all interfaces on the default port 4243.</li>
<li>Once the engine is running, you can manage it by installing CrashPlan on another computer, and editing the file <em>conf/ui.properties</em> on that computer so that this line:<br>
<code>#serviceHost=127.0.0.1</code><br>
is uncommented (by removing the hash symbol) and set to the IP address of your NAS, e.g.:<br>
<code>serviceHost=192.168.1.210</code><br>
On Windows you can also disable the CrashPlan service if you will only use the client.</li>
<li>If you need to manage CrashPlan from a remote location, I suggest you do so using SSH tunnelling as per this <a title="Connect to a Headless CrashPlan Desktop" href="http://support.crashplan.com/doku.php/how_to/configure_a_headless_client">support document</a>.</li>
<li>The package supports upgrading to future versions while preserving the machine identity, logs, login details, and cache. Upgrades can now take place without requiring a login from the client afterwards.</li>
<li>If you remove the package completely and re-install it later, you can re-attach to previous backups. When you log in to the Desktop Client with your existing account after a re-install, you can select “<a title="Adopting Another Computer" href="http://support.crashplan.com/doku.php/recipe/adopting_another_computer">adopt computer</a>” to merge the records, and preserve your existing backups. I haven’t tested whether this also re-attaches links to friends’ CrashPlan computers and backup sets, though the latter does seem possible in the Friends section of the GUI. It’s probably a good idea to test that this survives a package reinstall before you start relying on it. Sometimes, particularly with CrashPlan PRO I think, the adopt option is not offered. In this case you can log into CrashPlan Central and retrieve your computer’s GUID. On the CrashPlan client, double-click on the logo in the top right and you’ll enter a command line mode. You can use the GUID command to change the system’s GUID to the one you just retrieved from your account. </li>
<li>The log which is displayed in the package’s Log tab is actually the activity history. If you’re trying to troubleshoot an issue you will need to use an SSH session to inspect the two engine log files which are:<br>
<em>/volume1/@appstore/CrashPlan/log/engine_output.log<br>
/volume1/@appstore/CrashPlan/log/engine_error.log</em></li>
<li>When CrashPlan downloads and attempts to run an automatic update, the script will most likely fail and stop the package. This is typically caused by syntax differences with the Synology versions of certain Linux shell commands (like <em>rm</em>, <em>mv</em>, or <em>ps</em>). You will need to wait several minutes in the event of this happening before you take action, because the update script tries to restart CrashPlan 10 times at 10 second intervals. After this, you simply start the package again in Package Center and my scripts will fix the update, then run it. One final package restart is required  before you can connect with the CrashPlan Desktop client (remember to update that too).</li>
<li>After their backup is seeded some users may wish to schedule the CrashPlan engine using <a href="http://en.wikipedia.org/wiki/Cron" title="Cron - Wikipedia" target="_blank"><em>cron</em></a> so that it only runs at certain times. This is particularly useful on ARM systems because CrashPlan currently prevents hibernation while it is running (unresolved issue, reported to Code 42). To schedule, edit <em>/etc/crontab</em> and add the following entries for starting and stopping CrashPlan:<br>
<code>55 2 * * * root /var/packages/CrashPlan/scripts/start-stop-status start<br>
0&nbsp;&nbsp;4 * * * root /var/packages/CrashPlan/scripts/start-stop-status stop</code><br>
This example would configure CrashPlan to run daily between 02:55 and 04:00am. CrashPlan by default will scan the whole backup selection for changes at 3:00am so this is ideal. The simplest way to edit crontab if you’re not really confident with Linux is to install Merty’s <a href="http://www.mertymade.com/syno/#cfe" title="Mertymade.com - Config File Editor" target="_blank">Config File Editor</a> package, which requires the official Synology Perl package to be installed too (since DSM 4.2). After editing crontab you will need to restart the cron daemon for the changes to take effect:<br>
<code>/usr/syno/etc.defaults/rc.d/S04crond.sh stop<br>
/usr/syno/etc.defaults/rc.d/S04crond.sh start</code><br>
It is vitally important that you do not improvise your own startup commands or use a different account because this will most likely break the permissions on the config files, causing additional problems. The package scripts are designed to be run as root, and they will in turn invoke the CrashPlan engine using its own dedicated user account.</li>
<li>If you update DSM later, you will need to re-install the Java package or else UTF-8 and locale support will be broken by the update.</li>
<li>If you decide to sign up for one of CrashPlan’s paid backup services as a result of my work on this, I would really appreciate it if you could use <a href="http://gan.doubleclick.net/gan_click?lid=41000000035688872&amp;pubid=21000000000532076" title="CrashPlan+ for Linux is truly dependable backup to multiple locations with unlimited storage, backup sets and continuous secure online back up. " target="_blank">this affiliate link</a>, or consider donating using the PayPal button on the right.</li>
</ul>
<div>&nbsp;</div>
<h3>Package scripts</h3>
<p>For information, here are the package scripts so you can see what it’s going to do. You can get more information about how packages work by reading the <a title="Synology Package wiki" href="http://forum.synology.com/wiki/index.php/Synology_package_files" target="_none">Synology Package wiki</a>.</p>
<p><strong>installer.sh</strong></p>
<div><div id="highlighter_613803" class="syntaxhighlighter collapsed  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_expandSource expandSource">+ expand source</a></span><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div><div class="line number222 index221 alt1">222</div><div class="line number223 index222 alt2">223</div><div class="line number224 index223 alt1">224</div><div class="line number225 index224 alt2">225</div><div class="line number226 index225 alt1">226</div><div class="line number227 index226 alt2">227</div><div class="line number228 index227 alt1">228</div><div class="line number229 index228 alt2">229</div><div class="line number230 index229 alt1">230</div><div class="line number231 index230 alt2">231</div><div class="line number232 index231 alt1">232</div><div class="line number233 index232 alt2">233</div><div class="line number234 index233 alt1">234</div><div class="line number235 index234 alt2">235</div><div class="line number236 index235 alt1">236</div><div class="line number237 index236 alt2">237</div><div class="line number238 index237 alt1">238</div><div class="line number239 index238 alt2">239</div><div class="line number240 index239 alt1">240</div><div class="line number241 index240 alt2">241</div><div class="line number242 index241 alt1">242</div><div class="line number243 index242 alt2">243</div><div class="line number244 index243 alt1">244</div><div class="line number245 index244 alt2">245</div><div class="line number246 index245 alt1">246</div><div class="line number247 index246 alt2">247</div><div class="line number248 index247 alt1">248</div><div class="line number249 index248 alt2">249</div><div class="line number250 index249 alt1">250</div><div class="line number251 index250 alt2">251</div><div class="line number252 index251 alt1">252</div><div class="line number253 index252 alt2">253</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash preprocessor bold">#!/bin/sh</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="bash comments">#--------CRASHPLAN installer script</code></div><div class="line number4 index3 alt1"><code class="bash comments">#--------package maintained at pcloadletter.co.uk</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="bash plain">DOWNLOAD_PATH=</code><code class="bash string">"<a href="http://download.crashplan.com/installs/linux/install/">http://download.crashplan.com/installs/linux/install/</a>${SYNOPKG_PKGNAME}"</code></div><div class="line number7 index6 alt2"><code class="bash plain">[ </code><code class="bash string">"${SYNOPKG_PKGNAME}"</code> <code class="bash plain">== </code><code class="bash string">"CrashPlan"</code> <code class="bash plain">] &amp;&amp; DOWNLOAD_FILE=</code><code class="bash string">"CrashPlan_3.6.3_Linux.tgz"</code></div><div class="line number8 index7 alt1"><code class="bash plain">[ </code><code class="bash string">"${SYNOPKG_PKGNAME}"</code> <code class="bash plain">== </code><code class="bash string">"CrashPlanPRO"</code> <code class="bash plain">] &amp;&amp; DOWNLOAD_FILE=</code><code class="bash string">"CrashPlanPRO_3.6.3_Linux.tgz"</code></div><div class="line number9 index8 alt2"><code class="bash plain">[ </code><code class="bash string">"${SYNOPKG_PKGNAME}"</code> <code class="bash plain">== </code><code class="bash string">"CrashPlanPROe"</code> <code class="bash plain">] &amp;&amp; DOWNLOAD_FILE=</code><code class="bash string">"CrashPlanPROe_3.6.3_Linux.tgz"</code></div><div class="line number10 index9 alt1"><code class="bash plain">DOWNLOAD_URL=</code><code class="bash string">"${DOWNLOAD_PATH}/${DOWNLOAD_FILE}"</code></div><div class="line number11 index10 alt2"><code class="bash plain">CPI_FILE=</code><code class="bash string">"${SYNOPKG_PKGNAME}_*.cpi"</code></div><div class="line number12 index11 alt1"><code class="bash plain">EXTRACTED_FOLDER=</code><code class="bash string">"${SYNOPKG_PKGNAME}-install"</code></div><div class="line number13 index12 alt2"><code class="bash plain">DAEMON_USER=</code><code class="bash string">"`echo ${SYNOPKG_PKGNAME} | awk {'print tolower($_)'}`"</code></div><div class="line number14 index13 alt1"><code class="bash plain">DAEMON_PASS=</code><code class="bash string">"`openssl rand 12 -base64 2&gt;/dev/null`"</code></div><div class="line number15 index14 alt2"><code class="bash plain">DAEMON_ID=</code><code class="bash string">"${SYNOPKG_PKGNAME} daemon user"</code></div><div class="line number16 index15 alt1"><code class="bash plain">DAEMON_HOME=</code><code class="bash string">"/var/services/homes/${DAEMON_USER}"</code></div><div class="line number17 index16 alt2"><code class="bash plain">OPTDIR=</code><code class="bash string">"${SYNOPKG_PKGDEST}"</code></div><div class="line number18 index17 alt1"><code class="bash plain">VARS_FILE=</code><code class="bash string">"${OPTDIR}/install.vars"</code></div><div class="line number19 index18 alt2"><code class="bash plain">ENGINE_SCRIPT=</code><code class="bash string">"CrashPlanEngine"</code></div><div class="line number20 index19 alt1"><code class="bash plain">SYNO_CPU_ARCH=</code><code class="bash string">"`uname -m`"</code></div><div class="line number21 index20 alt2"><code class="bash plain">[ </code><code class="bash string">"${SYNO_CPU_ARCH}"</code> <code class="bash plain">== </code><code class="bash string">"x86_64"</code> <code class="bash plain">] &amp;&amp; SYNO_CPU_ARCH=</code><code class="bash string">"i686"</code></div><div class="line number22 index21 alt1"><code class="bash plain">NATIVE_BINS_URL=</code><code class="bash string">"<a href="http://packages.pcloadletter.co.uk/downloads/crashplan-native-">http://packages.pcloadletter.co.uk/downloads/crashplan-native-</a>${SYNO_CPU_ARCH}.tgz"</code>&nbsp;&nbsp;</div><div class="line number23 index22 alt2"><code class="bash plain">NATIVE_BINS_FILE=</code><code class="bash string">"`echo ${NATIVE_BINS_URL} | sed -r "</code><code class="bash plain">s%^.*/(.*)%\1%</code><code class="bash string">"`"</code></div><div class="line number24 index23 alt1"><code class="bash plain">INSTALL_FILES=</code><code class="bash string">"${DOWNLOAD_URL} ${NATIVE_BINS_URL}"</code></div><div class="line number25 index24 alt2"><code class="bash plain">TEMP_FOLDER=</code><code class="bash string">"`find / -maxdepth 2 -name '@tmp' | head -n 1`"</code></div><div class="line number26 index25 alt1"><code class="bash comments">#the Manifest folder is where friends' backup data is stored</code></div><div class="line number27 index26 alt2"><code class="bash comments">#we set it outside the app folder so it persists after a package uninstall</code></div><div class="line number28 index27 alt1"><code class="bash plain">MANIFEST_FOLDER=</code><code class="bash string">"/`echo $TEMP_FOLDER | cut -f2 -d'/'`/crashplan"</code></div><div class="line number29 index28 alt2"><code class="bash plain">LOG_FILE=</code><code class="bash string">"${SYNOPKG_PKGDEST}/log/history.log.0"</code></div><div class="line number30 index29 alt1"><code class="bash plain">UPGRADE_FILES=</code><code class="bash string">"syno_package.vars conf/my.service.xml conf/service.login conf/service.model"</code></div><div class="line number31 index30 alt2"><code class="bash plain">UPGRADE_FOLDERS=</code><code class="bash string">"log cache"</code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="bash functions">source</code> <code class="bash plain">/etc/profile</code></div><div class="line number34 index33 alt1"><code class="bash plain">PUBLIC_FOLDER=</code><code class="bash string">"`cat /usr/syno/etc/smb.conf | sed -r '/\/public$/!d;s/^.*path=(\/volume[0-9]{1,4}\/public).*$/\1/'`"</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="bash plain">preinst ()</code></div><div class="line number38 index37 alt1"><code class="bash plain">{</code></div><div class="line number39 index38 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -z ${PUBLIC_FOLDER} ]; </code><code class="bash keyword">then</code></div><div class="line number40 index39 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"A shared folder called 'public' could not be found - note this name is case-sensitive. "</code></div><div class="line number41 index40 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"Please create this using the Shared Folder DSM Control Panel and try again."</code></div><div class="line number42 index41 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">1</code></div><div class="line number43 index42 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -z ${JAVA_HOME} ]; </code><code class="bash keyword">then</code></div><div class="line number46 index45 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"Java is not installed or not properly configured. JAVA_HOME is not defined. "</code></div><div class="line number47 index46 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"Download and install the Java Synology package from <a href="http://wp.me/pVshC-z5">http://wp.me/pVshC-z5</a>"</code></div><div class="line number48 index47 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">1</code></div><div class="line number49 index48 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number50 index49 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number51 index50 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ ! -f ${JAVA_HOME}</code><code class="bash plain">/bin/java</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number52 index51 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"Java is not installed or not properly configured. The Java binary could not be located. "</code></div><div class="line number53 index52 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"Download and install the Java Synology package from <a href="http://wp.me/pVshC-z5">http://wp.me/pVshC-z5</a>"</code></div><div class="line number54 index53 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">1</code></div><div class="line number55 index54 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number56 index55 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number57 index56 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#is the User Home service enabled?</code></div><div class="line number58 index57 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">UH_SERVICE=maybe</code></div><div class="line number59 index58 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">synouser --add userhometest Testing123 </code><code class="bash string">"User Home test user"</code> <code class="bash plain">0 </code><code class="bash string">""</code> <code class="bash string">""</code></div><div class="line number60 index59 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">UHT_HOMEDIR=`</code><code class="bash functions">cat</code> <code class="bash plain">/etc/passwd</code> <code class="bash plain">| </code><code class="bash functions">sed</code> <code class="bash plain">-r </code><code class="bash string">'/User Home test user/!d;s/^.*:User Home test user:(.*):.*$/\1/'</code><code class="bash plain">`</code></div><div class="line number61 index60 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash functions">echo</code> <code class="bash plain">$UHT_HOMEDIR | </code><code class="bash functions">grep</code> <code class="bash string">'/var/services/homes/'</code> <code class="bash plain">&gt; </code><code class="bash plain">/dev/null</code><code class="bash plain">; </code><code class="bash keyword">then</code></div><div class="line number62 index61 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ ! -d $UHT_HOMEDIR ]; </code><code class="bash keyword">then</code></div><div class="line number63 index62 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">UH_SERVICE=</code><code class="bash functions">false</code></div><div class="line number64 index63 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number65 index64 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number66 index65 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">synouser --del userhometest</code></div><div class="line number67 index66 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#remove home directory (needed since DSM 4.1)</code></div><div class="line number68 index67 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">[ -e </code><code class="bash plain">/var/services/homes/userhometest</code> <code class="bash plain">] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">-r </code><code class="bash plain">/var/services/homes/userhometest</code></div><div class="line number69 index68 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${UH_SERVICE}"</code> <code class="bash plain">== </code><code class="bash string">"false"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number70 index69 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"The User Home service is not enabled. Please enable this feature in the User control panel in DSM."</code></div><div class="line number71 index70 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">1</code></div><div class="line number72 index71 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number73 index72 alt2"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number74 index73 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cd</code> <code class="bash plain">${TEMP_FOLDER}</code></div><div class="line number75 index74 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">for</code> <code class="bash plain">WGET_URL </code><code class="bash keyword">in</code> <code class="bash plain">${INSTALL_FILES}</code></div><div class="line number76 index75 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">do</code></div><div class="line number77 index76 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">WGET_FILENAME=</code><code class="bash string">"`echo ${WGET_URL} | sed -r "</code><code class="bash plain">s%^.*/(.*)%\1%</code><code class="bash string">"`"</code></div><div class="line number78 index77 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">[ -f ${TEMP_FOLDER}/${WGET_FILENAME} ] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">${TEMP_FOLDER}/${WGET_FILENAME}</code></div><div class="line number79 index78 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">wget ${WGET_URL}</code></div><div class="line number80 index79 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[[ $? != 0 ]]; </code><code class="bash keyword">then</code></div><div class="line number81 index80 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -d ${PUBLIC_FOLDER} ] &amp;&amp; [ -f ${PUBLIC_FOLDER}/${WGET_FILENAME} ]; </code><code class="bash keyword">then</code></div><div class="line number82 index81 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">${PUBLIC_FOLDER}/${WGET_FILENAME} ${TEMP_FOLDER}</code></div><div class="line number83 index82 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">else</code>&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="line number84 index83 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"There was a problem downloading ${WGET_FILENAME} from the official download link, "</code></div><div class="line number85 index84 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"which was \"${WGET_URL}\" "</code></div><div class="line number86 index85 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"Alternatively, you may download this file manually and place it in the 'public' shared folder. "</code></div><div class="line number87 index86 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">1</code></div><div class="line number88 index87 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number89 index88 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number90 index89 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number91 index90 alt2"><code class="bash spaces">&nbsp;</code>&nbsp;</div><div class="line number92 index91 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number93 index92 alt2"><code class="bash plain">}</code></div><div class="line number94 index93 alt1">&nbsp;</div><div class="line number95 index94 alt2">&nbsp;</div><div class="line number96 index95 alt1"><code class="bash plain">postinst ()</code></div><div class="line number97 index96 alt2"><code class="bash plain">{</code></div><div class="line number98 index97 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#create daemon user</code></div><div class="line number99 index98 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">synouser --add ${DAEMON_USER} ${DAEMON_PASS} </code><code class="bash string">"${DAEMON_ID}"</code> <code class="bash plain">0 </code><code class="bash string">""</code> <code class="bash string">""</code></div><div class="line number100 index99 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number101 index100 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#save the daemon user's homedir as variable in that user's profile</code></div><div class="line number102 index101 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#this is needed because new users seem to inherit a HOME value of /root which they have no permissions for.</code></div><div class="line number103 index102 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"echo export HOME=\'${DAEMON_HOME}\' &gt;&gt; .profile"</code></div><div class="line number104 index103 alt1">&nbsp;</div><div class="line number105 index104 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#extract CPU-specific additional binaries</code></div><div class="line number106 index105 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">mkdir</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/bin</code></div><div class="line number107 index106 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cd</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/bin</code></div><div class="line number108 index107 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">tar</code> <code class="bash plain">xzf ${TEMP_FOLDER}/${NATIVE_BINS_FILE} &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">${TEMP_FOLDER}/${NATIVE_BINS_FILE}</code></div><div class="line number109 index108 alt2">&nbsp;</div><div class="line number110 index109 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#extract main archive</code></div><div class="line number111 index110 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cd</code> <code class="bash plain">${TEMP_FOLDER}</code></div><div class="line number112 index111 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">tar</code> <code class="bash plain">xzf ${TEMP_FOLDER}/${DOWNLOAD_FILE} &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">${TEMP_FOLDER}/${DOWNLOAD_FILE} </code></div><div class="line number113 index112 alt2"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number114 index113 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#extract cpio archive</code></div><div class="line number115 index114 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cd</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code></div><div class="line number116 index115 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cat</code> <code class="bash string">"${TEMP_FOLDER}/${EXTRACTED_FOLDER}"</code><code class="bash plain">/${CPI_FILE} | </code><code class="bash functions">gzip</code> <code class="bash plain">-d -c | ${SYNOPKG_PKGDEST}</code><code class="bash plain">/bin/cpio</code> <code class="bash plain">-i --no-preserve-owner</code></div><div class="line number117 index116 alt2"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number118 index117 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"#uncomment to expand Java max heap size beyond prescribed value (will survive upgrades)"</code> <code class="bash plain">&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number119 index118 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"#you probably only want more than the recommended 512M if you're backing up extremely large volumes of files"</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number120 index119 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"#USR_MAX_HEAP=512M"</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number121 index120 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number122 index121 alt1">&nbsp;</div><div class="line number123 index122 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#the following Package Center variables will need retrieving if launching CrashPlan via cron</code></div><div class="line number124 index123 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"CRON_SYNOPKG_PKGNAME='${SYNOPKG_PKGNAME}'"</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number125 index124 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"CRON_SYNOPKG_PKGDEST='${SYNOPKG_PKGDEST}'"</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number126 index125 alt1">&nbsp;</div><div class="line number127 index126 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">${TEMP_FOLDER}/${EXTRACTED_FOLDER}</code><code class="bash plain">/scripts/</code><code class="bash plain">${ENGINE_SCRIPT} ${OPTDIR}</code><code class="bash plain">/bin</code></div><div class="line number128 index127 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">${TEMP_FOLDER}/${EXTRACTED_FOLDER}</code><code class="bash plain">/scripts/run</code><code class="bash plain">.conf ${OPTDIR}</code><code class="bash plain">/bin</code></div><div class="line number129 index128 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">mkdir</code> <code class="bash plain">-p ${MANIFEST_FOLDER}</code><code class="bash plain">/backupArchives</code>&nbsp;&nbsp;&nbsp;</div><div class="line number130 index129 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${MANIFEST_FOLDER}</code></div><div class="line number131 index130 alt2"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number132 index131 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#save install variables which Crashplan expects its own installer script to create</code></div><div class="line number133 index132 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash plain">TARGETDIR=${SYNOPKG_PKGDEST} &gt; ${VARS_FILE}</code></div><div class="line number134 index133 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash plain">BINSDIR=</code><code class="bash plain">/bin</code> <code class="bash plain">&gt;&gt; ${VARS_FILE}</code></div><div class="line number135 index134 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash plain">MANIFESTDIR=${MANIFEST_FOLDER}</code><code class="bash plain">/backupArchives</code> <code class="bash plain">&gt;&gt; ${VARS_FILE}</code></div><div class="line number136 index135 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#leave these ones out which should help upgrades from Code42 to work (based on examining an upgrade script)</code></div><div class="line number137 index136 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#echo INITDIR=/etc/init.d &gt;&gt; ${VARS_FILE}</code></div><div class="line number138 index137 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#echo RUNLVLDIR=/usr/syno/etc/rc.d &gt;&gt; ${VARS_FILE}</code></div><div class="line number139 index138 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash plain">INSTALLDATE=`</code><code class="bash functions">date</code> <code class="bash plain">+%Y%m%d` &gt;&gt; ${VARS_FILE}</code></div><div class="line number140 index139 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash plain">JAVACOMMON=\${JAVA_HOME}</code><code class="bash plain">/bin/java</code> <code class="bash plain">&gt;&gt; ${VARS_FILE}</code></div><div class="line number141 index140 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">cat</code> <code class="bash plain">${TEMP_FOLDER}/${EXTRACTED_FOLDER}</code><code class="bash plain">/install</code><code class="bash plain">.defaults &gt;&gt; ${VARS_FILE}</code></div><div class="line number142 index141 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number143 index142 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#remove temp files</code></div><div class="line number144 index143 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">rm</code> <code class="bash plain">-r ${TEMP_FOLDER}/${EXTRACTED_FOLDER}</code></div><div class="line number145 index144 alt2"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number146 index145 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#change owner of CrashPlan folder tree</code></div><div class="line number147 index146 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${SYNOPKG_PKGDEST}</code></div><div class="line number148 index147 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number149 index148 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number150 index149 alt1"><code class="bash plain">}</code></div><div class="line number151 index150 alt2">&nbsp;</div><div class="line number152 index151 alt1">&nbsp;</div><div class="line number153 index152 alt2"><code class="bash plain">preuninst ()</code></div><div class="line number154 index153 alt1"><code class="bash plain">{</code></div><div class="line number155 index154 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#make sure engine is stopped</code></div><div class="line number156 index155 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"${OPTDIR}/bin/${ENGINE_SCRIPT} stop"</code></div><div class="line number157 index156 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">sleep</code> <code class="bash plain">2</code></div><div class="line number158 index157 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number159 index158 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number160 index159 alt1"><code class="bash plain">}</code></div><div class="line number161 index160 alt2">&nbsp;</div><div class="line number162 index161 alt1">&nbsp;</div><div class="line number163 index162 alt2"><code class="bash plain">postuninst ()</code></div><div class="line number164 index163 alt1"><code class="bash plain">{</code></div><div class="line number165 index164 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -f ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars ]; </code><code class="bash keyword">then</code></div><div class="line number166 index165 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">source</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number167 index166 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number168 index167 alt1">&nbsp;</div><div class="line number169 index168 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${LIBFFI_SYMLINK}"</code> <code class="bash plain">== </code><code class="bash string">"YES"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number170 index169 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">rm</code> <code class="bash plain">/lib/libffi</code><code class="bash plain">.so.5</code></div><div class="line number171 index170 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number172 index171 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number173 index172 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#if it doesn't exist, but is still a link then it's a broken link and should also be deleted</code></div><div class="line number174 index173 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ ! -e </code><code class="bash plain">/lib/libffi</code><code class="bash plain">.so.5 ]; </code><code class="bash keyword">then</code></div><div class="line number175 index174 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">[ -L </code><code class="bash plain">/lib/libffi</code><code class="bash plain">.so.5 ] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">/lib/libffi</code><code class="bash plain">.so.5</code></div><div class="line number176 index175 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number177 index176 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number178 index177 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#remove daemon user</code></div><div class="line number179 index178 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">synouser --del ${DAEMON_USER}</code></div><div class="line number180 index179 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number181 index180 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#remove daemon user's home directory (needed since DSM 4.1)</code></div><div class="line number182 index181 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">[ -e </code><code class="bash plain">/var/services/homes/</code><code class="bash plain">${DAEMON_USER} ] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">-r </code><code class="bash plain">/var/services/homes/</code><code class="bash plain">${DAEMON_USER}</code></div><div class="line number183 index182 alt2"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number184 index183 alt1"><code class="bash spaces">&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number185 index184 alt2"><code class="bash plain">}</code></div><div class="line number186 index185 alt1">&nbsp;</div><div class="line number187 index186 alt2"><code class="bash plain">preupgrade ()</code></div><div class="line number188 index187 alt1"><code class="bash plain">{</code></div><div class="line number189 index188 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#make sure engine is stopped</code></div><div class="line number190 index189 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"${OPTDIR}/bin/${ENGINE_SCRIPT} stop"</code></div><div class="line number191 index190 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">sleep</code> <code class="bash plain">2</code></div><div class="line number192 index191 alt1"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number193 index192 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#if identity and config data exists back it up</code></div><div class="line number194 index193 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -d ${DAEMON_HOME}/.crashplan ]; </code><code class="bash keyword">then</code></div><div class="line number195 index194 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mkdir</code> <code class="bash plain">-p ${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig</code><code class="bash plain">/conf</code></div><div class="line number196 index195 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mv</code> <code class="bash plain">${DAEMON_HOME}/.crashplan ${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig</code></div><div class="line number197 index196 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">for</code> <code class="bash plain">FILE_TO_MIGRATE </code><code class="bash keyword">in</code> <code class="bash plain">${UPGRADE_FILES}; </code><code class="bash keyword">do</code></div><div class="line number198 index197 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -f ${OPTDIR}/${FILE_TO_MIGRATE} ]; </code><code class="bash keyword">then</code></div><div class="line number199 index198 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">${OPTDIR}/${FILE_TO_MIGRATE} ${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig/${FILE_TO_MIGRATE}</code></div><div class="line number200 index199 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number201 index200 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number202 index201 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">for</code> <code class="bash plain">FOLDER_TO_MIGRATE </code><code class="bash keyword">in</code> <code class="bash plain">${UPGRADE_FOLDERS}; </code><code class="bash keyword">do</code></div><div class="line number203 index202 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -d ${OPTDIR}/${FOLDER_TO_MIGRATE} ]; </code><code class="bash keyword">then</code></div><div class="line number204 index203 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mv</code> <code class="bash plain">${OPTDIR}/${FOLDER_TO_MIGRATE} ${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig</code></div><div class="line number205 index204 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number206 index205 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number207 index206 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number208 index207 alt1">&nbsp;</div><div class="line number209 index208 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number210 index209 alt1"><code class="bash plain">}</code></div><div class="line number211 index210 alt2">&nbsp;</div><div class="line number212 index211 alt1">&nbsp;</div><div class="line number213 index212 alt2"><code class="bash plain">postupgrade ()</code></div><div class="line number214 index213 alt1"><code class="bash plain">{</code></div><div class="line number215 index214 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#use the migrated identity and config data from the previous version</code></div><div class="line number216 index215 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -d ${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig/.crashplan ]; </code><code class="bash keyword">then</code></div><div class="line number217 index216 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mv</code> <code class="bash plain">${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig/.crashplan ${DAEMON_HOME}</code></div><div class="line number218 index217 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">for</code> <code class="bash plain">FILE_TO_MIGRATE </code><code class="bash keyword">in</code> <code class="bash plain">${UPGRADE_FILES}; </code><code class="bash keyword">do</code></div><div class="line number219 index218 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -f ${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig/${FILE_TO_MIGRATE} ]; </code><code class="bash keyword">then</code></div><div class="line number220 index219 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mv</code> <code class="bash plain">${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig/${FILE_TO_MIGRATE} ${OPTDIR}/${FILE_TO_MIGRATE}</code></div><div class="line number221 index220 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number222 index221 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number223 index222 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">for</code> <code class="bash plain">FOLDER_TO_MIGRATE </code><code class="bash keyword">in</code> <code class="bash plain">${UPGRADE_FOLDERS}; </code><code class="bash keyword">do</code></div><div class="line number224 index223 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -d ${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig/${FOLDER_TO_MIGRATE} ]; </code><code class="bash keyword">then</code></div><div class="line number225 index224 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mv</code> <code class="bash plain">${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig/${FOLDER_TO_MIGRATE} ${OPTDIR}</code></div><div class="line number226 index225 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number227 index226 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number228 index227 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">rmdir</code> <code class="bash plain">${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig</code><code class="bash plain">/conf</code></div><div class="line number229 index228 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">rmdir</code> <code class="bash plain">${SYNOPKG_PKGDEST}/../${DAEMON_USER}_data_mig</code></div><div class="line number230 index229 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number231 index230 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#make CrashPlan log entry</code></div><div class="line number232 index231 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">TIMESTAMP=</code><code class="bash string">"`date +%D` `date +%I:%M%p`"</code></div><div class="line number233 index232 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"I ${TIMESTAMP} Synology Package Center updated ${SYNOPKG_PKGNAME} to version ${SYNOPKG_PKGVER}"</code> <code class="bash plain">&gt;&gt; ${LOG_FILE}</code></div><div class="line number234 index233 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number235 index234 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#daemon user has been deleted and recreated so we need to reset ownership (new UID)</code></div><div class="line number236 index235 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${DAEMON_HOME}/.crashplan</code></div><div class="line number237 index236 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${SYNOPKG_PKGDEST}</code></div><div class="line number238 index237 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number239 index238 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#read manifest location from the migrated XML config, and reset ownership on that path too</code></div><div class="line number240 index239 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -f ${SYNOPKG_PKGDEST}</code><code class="bash plain">/conf/my</code><code class="bash plain">.service.xml ]; </code><code class="bash keyword">then</code></div><div class="line number241 index240 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">MANIFEST_FOLDER=`</code><code class="bash functions">cat</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/conf/my</code><code class="bash plain">.service.xml | </code><code class="bash functions">grep</code> <code class="bash string">"&lt;manifestPath&gt;"</code> <code class="bash plain">| </code><code class="bash functions">cut</code> <code class="bash plain">-f2 -d</code><code class="bash string">'&gt;'</code> <code class="bash plain">| </code><code class="bash functions">cut</code> <code class="bash plain">-f1 -d</code><code class="bash string">'&lt;'</code><code class="bash plain">`</code></div><div class="line number242 index241 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${MANIFEST_FOLDER}</code></div><div class="line number243 index242 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number244 index243 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number245 index244 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#the following Package Center variables will need retrieving if launching CrashPlan via cron</code></div><div class="line number246 index245 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">grep</code> <code class="bash string">"^CRON_SYNOPKG_PKGNAME"</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars &gt; </code><code class="bash plain">/dev/null</code> <code class="bash plain">\</code></div><div class="line number247 index246 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">|| </code><code class="bash functions">echo</code> <code class="bash string">"CRON_SYNOPKG_PKGNAME='${SYNOPKG_PKGNAME}'"</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number248 index247 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">grep</code> <code class="bash string">"^CRON_SYNOPKG_PKGDEST"</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars &gt; </code><code class="bash plain">/dev/null</code> <code class="bash plain">\</code></div><div class="line number249 index248 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">|| </code><code class="bash functions">echo</code> <code class="bash string">"CRON_SYNOPKG_PKGDEST='${SYNOPKG_PKGDEST}'"</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number250 index249 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number251 index250 alt2"><code class="bash spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number252 index251 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number253 index252 alt2"><code class="bash plain">}</code></div></div></td></tr></tbody></table></div></div>
<div>&nbsp;</div>
<p><strong>start-stop-status.sh</strong></p>
<div><div id="highlighter_90835" class="syntaxhighlighter collapsed  bash"><div class="toolbar"><span><a href="#" class="toolbar_item command_expandSource expandSource">+ expand source</a></span><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash preprocessor bold">#!/bin/sh</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="bash comments">#--------CRASHPLAN start-stop-status script</code></div><div class="line number4 index3 alt1"><code class="bash comments">#--------package maintained at pcloadletter.co.uk</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${SYNOPKG_PKGNAME}"</code> <code class="bash plain">== </code><code class="bash string">""</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number7 index6 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash comments">#if this script has been invoked by cron then some Package Center vars are undefined</code></div><div class="line number8 index7 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash functions">source</code> <code class="bash string">"`dirname $0`/../target/syno_package.vars"</code></div><div class="line number9 index8 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">SYNOPKG_PKGNAME=</code><code class="bash string">"${CRON_SYNOPKG_PKGNAME}"</code></div><div class="line number10 index9 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">SYNOPKG_PKGDEST=</code><code class="bash string">"${CRON_SYNOPKG_PKGDEST}"</code></div><div class="line number11 index10 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">CRON_LAUNCHED=True</code></div><div class="line number12 index11 alt1"><code class="bash keyword">fi</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="bash comments">#Main variables section</code></div><div class="line number15 index14 alt2"><code class="bash plain">DAEMON_USER=</code><code class="bash string">"`echo ${SYNOPKG_PKGNAME} | awk {'print tolower($_)'}`"</code></div><div class="line number16 index15 alt1"><code class="bash plain">DAEMON_HOME=</code><code class="bash string">"/var/services/homes/${DAEMON_USER}"</code></div><div class="line number17 index16 alt2"><code class="bash plain">OPTDIR=</code><code class="bash string">"${SYNOPKG_PKGDEST}"</code></div><div class="line number18 index17 alt1"><code class="bash plain">TEMP_FOLDER=</code><code class="bash string">"`find / -maxdepth 2 -name '@tmp' | head -n 1`"</code></div><div class="line number19 index18 alt2"><code class="bash plain">MANIFEST_FOLDER=</code><code class="bash string">"/`echo $TEMP_FOLDER | cut -f2 -d'/'`/crashplan"</code></div><div class="line number20 index19 alt1"><code class="bash plain">LOG_FILE=</code><code class="bash string">"${SYNOPKG_PKGDEST}/log/history.log.0"</code></div><div class="line number21 index20 alt2"><code class="bash plain">ENGINE_SCRIPT=</code><code class="bash string">"CrashPlanEngine"</code></div><div class="line number22 index21 alt1"><code class="bash plain">APP_NAME=</code><code class="bash string">"CrashPlanService"</code></div><div class="line number23 index22 alt2"><code class="bash plain">SCRIPTS_TO_EDIT=</code><code class="bash string">"${ENGINE_SCRIPT}"</code></div><div class="line number24 index23 alt1"><code class="bash plain">ENGINE_CFG=</code><code class="bash string">"run.conf"</code></div><div class="line number25 index24 alt2"><code class="bash plain">LIBFFI_SO_NAMES=</code><code class="bash string">"5 6"</code> <code class="bash comments">#armada370 build of libjnidispatch.so is newer, and uses libffi.so.6</code></div><div class="line number26 index25 alt1"><code class="bash plain">CFG_PARAM=</code><code class="bash string">"SRV_JAVA_OPTS"</code></div><div class="line number27 index26 alt2"><code class="bash functions">source</code> <code class="bash plain">${OPTDIR}</code><code class="bash plain">/install</code><code class="bash plain">.vars</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="bash plain">JAVA_MIN_HEAP=`</code><code class="bash functions">grep</code> <code class="bash string">"^${CFG_PARAM}="</code> <code class="bash string">"${OPTDIR}/bin/${ENGINE_CFG}"</code> <code class="bash plain">| </code><code class="bash functions">sed</code> <code class="bash plain">-r </code><code class="bash string">"s/^.*-Xms([0-9]+)[Mm] .*$/\1/"</code><code class="bash plain">`</code></div><div class="line number30 index29 alt1"><code class="bash plain">SYNO_CPU_ARCH=</code><code class="bash string">"`uname -m`"</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="bash keyword">case</code> <code class="bash plain">$1 </code><code class="bash keyword">in</code></div><div class="line number34 index33 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">start)&nbsp;&nbsp;&nbsp; </code></div><div class="line number35 index34 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#set the current timezone for Java so that log timestamps are accurate</code></div><div class="line number36 index35 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#we need to use the modern timezone names so that Java can figure out DST </code></div><div class="line number37 index36 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">SYNO_TZ=`</code><code class="bash functions">cat</code> <code class="bash plain">/etc/synoinfo</code><code class="bash plain">.conf | </code><code class="bash functions">grep</code> <code class="bash plain">timezone | </code><code class="bash functions">cut</code> <code class="bash plain">-f2 -d</code><code class="bash string">'"'</code><code class="bash plain">`</code></div><div class="line number38 index37 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">SYNO_TZ=`</code><code class="bash functions">grep</code> <code class="bash string">"^${SYNO_TZ}"</code> <code class="bash plain">/usr/share/zoneinfo/Timezone/tzname</code> <code class="bash plain">| </code><code class="bash functions">sed</code> <code class="bash plain">-e </code><code class="bash string">"s/^.*= //"</code><code class="bash plain">`</code></div><div class="line number39 index38 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">grep</code> <code class="bash string">"^export TZ"</code> <code class="bash plain">${DAEMON_HOME}/.profile &gt; </code><code class="bash plain">/dev/null</code> <code class="bash plain">\</code></div><div class="line number40 index39 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">&amp;&amp; </code><code class="bash functions">sed</code> <code class="bash plain">-i </code><code class="bash string">"s%^export TZ=.*$%export TZ='${SYNO_TZ}'%"</code> <code class="bash plain">${DAEMON_HOME}/.profile \</code></div><div class="line number41 index40 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">|| </code><code class="bash functions">echo</code> <code class="bash functions">export</code> <code class="bash plain">TZ=\'${SYNO_TZ}\' &gt;&gt; ${DAEMON_HOME}/.profile</code></div><div class="line number42 index41 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#this package stores the machine identity in the daemon user home directory</code></div><div class="line number43 index42 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#so we need to remove any old config data from previous manual installations or startups</code></div><div class="line number44 index43 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">[ -d </code><code class="bash plain">/var/lib/crashplan</code> <code class="bash plain">] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">-r </code><code class="bash plain">/var/lib/crashplan</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#check persistent variables from syno_package.vars</code></div><div class="line number47 index46 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">USR_MAX_HEAP=0</code></div><div class="line number48 index47 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -f ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars ]; </code><code class="bash keyword">then</code></div><div class="line number49 index48 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">source</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number50 index49 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number51 index50 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">USR_MAX_HEAP=`</code><code class="bash functions">echo</code> <code class="bash plain">$USR_MAX_HEAP | </code><code class="bash functions">sed</code> <code class="bash plain">-e </code><code class="bash string">"s/[mM]//"</code><code class="bash plain">`</code></div><div class="line number52 index51 alt1">&nbsp;</div><div class="line number53 index52 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#create or repair libffi symlink if a DSM upgrade has removed it</code></div><div class="line number54 index53 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">for</code> <code class="bash plain">FFI_VER </code><code class="bash keyword">in</code> <code class="bash plain">${LIBFFI_SO_NAMES}; </code><code class="bash keyword">do</code></div><div class="line number55 index54 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -e ${OPTDIR}</code><code class="bash plain">/lib/libffi</code><code class="bash plain">.so.${FFI_VER} ]; </code><code class="bash keyword">then</code></div><div class="line number56 index55 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ ! -e </code><code class="bash plain">/lib/libffi</code><code class="bash plain">.so.${FFI_VER} ]; </code><code class="bash keyword">then</code></div><div class="line number57 index56 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#if it doesn't exist, but is still a link then it's a broken link and should be deleted</code></div><div class="line number58 index57 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">[ -L </code><code class="bash plain">/lib/libffi</code><code class="bash plain">.so.${FFI_VER} ] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">/lib/libffi</code><code class="bash plain">.so.${FFI_VER}</code></div><div class="line number59 index58 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">ln</code> <code class="bash plain">-s ${OPTDIR}</code><code class="bash plain">/lib/libffi</code><code class="bash plain">.so.${FFI_VER} </code><code class="bash plain">/lib/libffi</code><code class="bash plain">.so.${FFI_VER}</code></div><div class="line number60 index59 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number61 index60 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number62 index61 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number63 index62 alt2">&nbsp;</div><div class="line number64 index63 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#fix up some of the binary paths and fix some command syntax for busybox </code></div><div class="line number65 index64 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#moved this to start-stop-status from installer.sh because Code42 push updates and these</code></div><div class="line number66 index65 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#new scripts will need this treatment too</code></div><div class="line number67 index66 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">FIND_TARGETS=</code></div><div class="line number68 index67 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">for</code> <code class="bash plain">TARGET </code><code class="bash keyword">in</code> <code class="bash plain">${SCRIPTS_TO_EDIT}; </code><code class="bash keyword">do</code></div><div class="line number69 index68 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">FIND_TARGETS=</code><code class="bash string">"${FIND_TARGETS} -o -name ${TARGET}"</code></div><div class="line number70 index69 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number71 index70 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">find</code> <code class="bash plain">${OPTDIR} \( -name \*.sh ${FIND_TARGETS} \) | </code><code class="bash keyword">while</code> <code class="bash plain">IFS=</code><code class="bash string">""</code> <code class="bash functions">read</code> <code class="bash plain">-r FILE_TO_EDIT; </code><code class="bash keyword">do</code></div><div class="line number72 index71 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -e ${FILE_TO_EDIT} ]; </code><code class="bash keyword">then</code></div><div class="line number73 index72 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#this list of substitutions will probably need expanding as new CrashPlan updates are released</code></div><div class="line number74 index73 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i </code><code class="bash string">"s%^#!/bin/bash%#!${SYNOPKG_PKGDEST}/bin/bash%"</code> <code class="bash string">"${FILE_TO_EDIT}"</code></div><div class="line number75 index74 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i -r </code><code class="bash string">"s%(^\s*)nice -n%\1${SYNOPKG_PKGDEST}/bin/nice -n%"</code> <code class="bash string">"${FILE_TO_EDIT}"</code></div><div class="line number76 index75 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i -r </code><code class="bash string">"s%(^\s*)(/bin/ps|ps) [^\|]*\|%\1/bin/ps w \|%"</code> <code class="bash string">"${FILE_TO_EDIT}"</code></div><div class="line number77 index76 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i -r </code><code class="bash string">"s%\`ps [^\|]*\|%\`ps w \|%"</code> <code class="bash string">"${FILE_TO_EDIT}"</code></div><div class="line number78 index77 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i </code><code class="bash string">"s/rm -fv/rm -f/"</code> <code class="bash string">"${FILE_TO_EDIT}"</code></div><div class="line number79 index78 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i </code><code class="bash string">"s/mv -fv/mv -f/"</code> <code class="bash string">"${FILE_TO_EDIT}"</code></div><div class="line number80 index79 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number81 index80 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number82 index81 alt1">&nbsp;</div><div class="line number83 index82 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#any downloaded upgrade script will usually have failed until the above changes are made so we need to</code></div><div class="line number84 index83 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#find it and start it, if it exists</code></div><div class="line number85 index84 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">UPGRADE_SCRIPT=`</code><code class="bash functions">find</code> <code class="bash plain">${OPTDIR}</code><code class="bash plain">/upgrade</code> <code class="bash plain">-name </code><code class="bash string">"upgrade.sh"</code><code class="bash plain">`</code></div><div class="line number86 index85 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -n </code><code class="bash string">"${UPGRADE_SCRIPT}"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number87 index86 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">rm</code> <code class="bash plain">${OPTDIR}/${ENGINE_SCRIPT}.pid</code></div><div class="line number88 index87 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">SCRIPT_HOME=`</code><code class="bash functions">dirname</code> <code class="bash plain">$UPGRADE_SCRIPT`</code></div><div class="line number89 index88 alt2">&nbsp;</div><div class="line number90 index89 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#make CrashPlan log entry</code></div><div class="line number91 index90 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">TIMESTAMP=</code><code class="bash string">"`date +%D` `date +%I:%M%p`"</code></div><div class="line number92 index91 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"I ${TIMESTAMP} Synology repairing upgrade in ${SCRIPT_HOME}"</code> <code class="bash plain">&gt;&gt; ${LOG_FILE}</code></div><div class="line number93 index92 alt2">&nbsp;</div><div class="line number94 index93 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mv</code> <code class="bash plain">${SCRIPT_HOME}</code><code class="bash plain">/upgrade</code><code class="bash plain">.log ${SCRIPT_HOME}</code><code class="bash plain">/upgrade</code><code class="bash plain">.log.old</code></div><div class="line number95 index94 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${SYNOPKG_PKGDEST}</code></div><div class="line number96 index95 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"cd ${SCRIPT_HOME} ; . upgrade.sh"</code></div><div class="line number97 index96 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">mv</code> <code class="bash plain">${SCRIPT_HOME}</code><code class="bash plain">/upgrade</code><code class="bash plain">.sh ${SCRIPT_HOME}</code><code class="bash plain">/upgrade</code><code class="bash plain">.sh.old</code></div><div class="line number98 index97 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number99 index98 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number100 index99 alt1">&nbsp;</div><div class="line number101 index100 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#updates may also overwrite our native binaries</code></div><div class="line number102 index101 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${SYNO_CPU_ARCH}"</code> <code class="bash plain">== </code><code class="bash string">"x86_64"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number103 index102 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">${SYNOPKG_PKGDEST}</code><code class="bash plain">/bin/synology-x86-glibc-2</code><code class="bash plain">.4-shim.so ${OPTDIR}</code><code class="bash plain">/lib</code></div><div class="line number104 index103 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">else</code>&nbsp;&nbsp;&nbsp;</div><div class="line number105 index104 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">-f ${SYNOPKG_PKGDEST}</code><code class="bash plain">/bin/libjtux</code><code class="bash plain">.so ${OPTDIR}</code></div><div class="line number106 index105 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">-f ${SYNOPKG_PKGDEST}</code><code class="bash plain">/bin/jna-3</code><code class="bash plain">.2.5.jar ${OPTDIR}</code><code class="bash plain">/lib</code></div><div class="line number107 index106 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">cp</code> <code class="bash plain">-f ${SYNOPKG_PKGDEST}</code><code class="bash plain">/bin/libffi</code><code class="bash plain">.so.* ${OPTDIR}</code><code class="bash plain">/lib</code></div><div class="line number108 index107 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number109 index108 alt2">&nbsp;</div><div class="line number110 index109 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#set appropriate Java max heap size</code></div><div class="line number111 index110 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">RAM=$((`</code><code class="bash functions">free</code> <code class="bash plain">| </code><code class="bash functions">grep</code> <code class="bash plain">Mem: | </code><code class="bash functions">sed</code> <code class="bash plain">-e </code><code class="bash string">"s/^ *Mem: *\([0-9]*\).*$/\1/"</code><code class="bash plain">`</code><code class="bash plain">/1024</code><code class="bash plain">))</code></div><div class="line number112 index111 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ $RAM -</code><code class="bash keyword">le</code> <code class="bash plain">128 ]; </code><code class="bash keyword">then</code></div><div class="line number113 index112 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">JAVA_MAX_HEAP=80</code></div><div class="line number114 index113 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">elif</code> <code class="bash plain">[ $RAM -</code><code class="bash keyword">le</code> <code class="bash plain">256 ]; </code><code class="bash keyword">then</code></div><div class="line number115 index114 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">JAVA_MAX_HEAP=192</code></div><div class="line number116 index115 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">elif</code> <code class="bash plain">[ $RAM -</code><code class="bash keyword">le</code> <code class="bash plain">512 ]; </code><code class="bash keyword">then</code></div><div class="line number117 index116 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">JAVA_MAX_HEAP=384</code></div><div class="line number118 index117 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#CrashPlan's default max heap is 512MB</code></div><div class="line number119 index118 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">elif</code> <code class="bash plain">[ $RAM -gt 512 ]; </code><code class="bash keyword">then</code></div><div class="line number120 index119 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">JAVA_MAX_HEAP=512</code></div><div class="line number121 index120 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number122 index121 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ $USR_MAX_HEAP -gt $JAVA_MAX_HEAP ]; </code><code class="bash keyword">then</code></div><div class="line number123 index122 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">JAVA_MAX_HEAP=${USR_MAX_HEAP}</code></div><div class="line number124 index123 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code>&nbsp;&nbsp;</div><div class="line number125 index124 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ $JAVA_MAX_HEAP -lt $JAVA_MIN_HEAP ]; </code><code class="bash keyword">then</code></div><div class="line number126 index125 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#can't have a max heap lower than min heap (ARM low RAM systems)</code></div><div class="line number127 index126 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">$JAVA_MAX_HEAP=$JAVA_MIN_HEAP</code></div><div class="line number128 index127 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number129 index128 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i -r </code><code class="bash string">"s/(^${CFG_PARAM}=.*) -Xmx[0-9]+[mM] (.*$)/\1 -Xmx${JAVA_MAX_HEAP}m \2/"</code> <code class="bash string">"${OPTDIR}/bin/${ENGINE_CFG}"</code></div><div class="line number130 index129 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number131 index130 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#disable the use of the x86-optimized external Fast MD5 library if running on ARM and QorIQ CPUs</code></div><div class="line number132 index131 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#seems to be the default behaviour now but that may change again</code></div><div class="line number133 index132 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${SYNO_CPU_ARCH}"</code> <code class="bash plain">!= </code><code class="bash string">"x86_64"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number134 index133 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">grep</code> <code class="bash string">"^${CFG_PARAM}=.*c42\.native\.md5\.enabled"</code> <code class="bash string">"${OPTDIR}/bin/${ENGINE_CFG}"</code> <code class="bash plain">&gt; </code><code class="bash plain">/dev/null</code> <code class="bash plain">\</code></div><div class="line number135 index134 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">|| </code><code class="bash functions">sed</code> <code class="bash plain">-i -r </code><code class="bash string">"s/(^${CFG_PARAM}=\".*)\"$/\1 -Dc42.native.md5.enabled=false\"/"</code> <code class="bash string">"${OPTDIR}/bin/${ENGINE_CFG}"</code></div><div class="line number136 index135 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number137 index136 alt2">&nbsp;</div><div class="line number138 index137 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#move the Java temp directory from the default of /tmp</code></div><div class="line number139 index138 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">grep</code> <code class="bash string">"^${CFG_PARAM}=.*Djava\.io\.tmpdir"</code> <code class="bash string">"${OPTDIR}/bin/${ENGINE_CFG}"</code> <code class="bash plain">&gt; </code><code class="bash plain">/dev/null</code> <code class="bash plain">\</code></div><div class="line number140 index139 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">|| </code><code class="bash functions">sed</code> <code class="bash plain">-i -r </code><code class="bash string">"s%(^${CFG_PARAM}=\".*)\"$%\1 -Djava.io.tmpdir=${TEMP_FOLDER}\"%"</code> <code class="bash string">"${OPTDIR}/bin/${ENGINE_CFG}"</code></div><div class="line number141 index140 alt2">&nbsp;</div><div class="line number142 index141 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#reset ownership of all files to daemon user, so that manual edits to config files won't cause problems</code></div><div class="line number143 index142 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${SYNOPKG_PKGDEST}</code></div><div class="line number144 index143 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">chown</code> <code class="bash plain">-R ${DAEMON_USER} ${DAEMON_HOME}&nbsp;&nbsp;&nbsp; </code></div><div class="line number145 index144 alt2">&nbsp;</div><div class="line number146 index145 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#now edit the XML config file, which only exists after first run</code></div><div class="line number147 index146 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -f ${SYNOPKG_PKGDEST}</code><code class="bash plain">/conf/my</code><code class="bash plain">.service.xml ]; </code><code class="bash keyword">then</code></div><div class="line number148 index147 alt1">&nbsp;</div><div class="line number149 index148 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#allow direct connections from CrashPlan Desktop client on remote systems</code></div><div class="line number150 index149 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#you must edit the value of serviceHost in conf/ui.properties on the client you connect with</code></div><div class="line number151 index150 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#users report that this value is sometimes reset so now it's set every service startup </code></div><div class="line number152 index151 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i </code><code class="bash string">"s/&lt;serviceHost&gt;127\.0\.0\.1&lt;\/serviceHost&gt;/&lt;serviceHost&gt;0\.0\.0\.0&lt;\/serviceHost&gt;/"</code> <code class="bash string">"${SYNOPKG_PKGDEST}/conf/my.service.xml"</code></div><div class="line number153 index152 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number154 index153 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#this change is made only once in case you want to customize the friends' backup location</code></div><div class="line number155 index154 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${MANIFEST_PATH_SET}"</code> <code class="bash plain">!= </code><code class="bash string">"True"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number156 index155 alt1">&nbsp;</div><div class="line number157 index156 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#keep friends' backup data outside the application folder to make accidental deletion less likely </code></div><div class="line number158 index157 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i </code><code class="bash string">"s%&lt;manifestPath&gt;.*&lt;/manifestPath&gt;%&lt;manifestPath&gt;${MANIFEST_FOLDER}/backupArchives/&lt;/manifestPath&gt;%"</code> <code class="bash string">"${SYNOPKG_PKGDEST}/conf/my.service.xml"</code></div><div class="line number159 index158 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"MANIFEST_PATH_SET=True"</code> <code class="bash plain">&gt;&gt; ${SYNOPKG_PKGDEST}</code><code class="bash plain">/syno_package</code><code class="bash plain">.vars</code></div><div class="line number160 index159 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number161 index160 alt2">&nbsp;</div><div class="line number162 index161 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#since CrashPlan version 3.5.3 the value javaMemoryHeapMax also needs setting to match that used in bin/run.conf</code></div><div class="line number163 index162 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">sed</code> <code class="bash plain">-i -r </code><code class="bash string">"s%(&lt;javaMemoryHeapMax&gt;)[0-9]+[mM](&lt;/javaMemoryHeapMax&gt;)%\1${JAVA_MAX_HEAP}m\2%"</code> <code class="bash string">"${SYNOPKG_PKGDEST}/conf/my.service.xml"</code></div><div class="line number164 index163 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">else</code></div><div class="line number165 index164 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"Wait a few seconds, then stop and restart the package to allow desktop client connections."</code> <code class="bash plain">&gt; </code><code class="bash string">"${SYNOPKG_TEMP_LOGFILE}"</code></div><div class="line number166 index165 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number167 index166 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${CRON_LAUNCHED}"</code> <code class="bash plain">== </code><code class="bash string">"True"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number168 index167 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">[ -e </code><code class="bash plain">/var/packages/</code><code class="bash plain">${SYNOPKG_PKGNAME}</code><code class="bash plain">/enabled</code> <code class="bash plain">] || </code><code class="bash functions">touch</code> <code class="bash plain">/var/packages/</code><code class="bash plain">${SYNOPKG_PKGNAME}</code><code class="bash plain">/enabled</code></div><div class="line number169 index168 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number170 index169 alt1">&nbsp;</div><div class="line number171 index170 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#delete any stray Java temp files</code></div><div class="line number172 index171 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">find</code> <code class="bash plain">/tmp</code> <code class="bash plain">-name </code><code class="bash string">"jna*.tmp"</code> <code class="bash plain">-user ${DAEMON_USER} | </code><code class="bash keyword">while</code> <code class="bash plain">IFS=</code><code class="bash string">""</code> <code class="bash functions">read</code> <code class="bash plain">-r FILE_TO_DEL; </code><code class="bash keyword">do</code></div><div class="line number173 index172 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -e ${FILE_TO_DEL} ]; </code><code class="bash keyword">then</code></div><div class="line number174 index173 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">rm</code> <code class="bash plain">${FILE_TO_DEL}</code></div><div class="line number175 index174 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number176 index175 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">done</code></div><div class="line number177 index176 alt2">&nbsp;</div><div class="line number178 index177 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#increase the system-wide maximum number of open files from Synology default of 24466</code></div><div class="line number179 index178 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"65536"</code> <code class="bash plain">&gt; </code><code class="bash plain">/proc/sys/fs/file-max</code></div><div class="line number180 index179 alt1">&nbsp;</div><div class="line number181 index180 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#raise the maximum open file count from the Synology default of 1024 - thanks Casper K. for figuring this out</code></div><div class="line number182 index181 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#<a href="http://support.code42.com/Administrator/3.6_And_4.0/Troubleshooting/Too_Many_Open_Files">http://support.code42.com/Administrator/3.6_And_4.0/Troubleshooting/Too_Many_Open_Files</a></code></div><div class="line number183 index182 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">ulimit</code> <code class="bash plain">-n 65536</code></div><div class="line number184 index183 alt1">&nbsp;</div><div class="line number185 index184 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${SYNO_CPU_ARCH}"</code> <code class="bash plain">== </code><code class="bash string">"x86_64"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number186 index185 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#Intel synos running older DSM need rwojo's glibc version shim for inotify support</code></div><div class="line number187 index186 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash comments">#<a href="https://github.com/wojo/synology-x86-glibc-2.4-shim">https://github.com/wojo/synology-x86-glibc-2.4-shim</a></code></div><div class="line number188 index187 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">GLIBC_VER=</code><code class="bash string">"`/lib/libc.so.6 | grep -m 1 version | sed -r "</code><code class="bash plain">s/^[^0-9]*([0-9].*[0-9])\,.*$/\1/</code><code class="bash string">"`"</code></div><div class="line number189 index188 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${GLIBC_VER}"</code> <code class="bash plain">== </code><code class="bash string">"2.3.6"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number190 index189 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"LD_PRELOAD=${SYNOPKG_PKGDEST}/lib/synology-x86-glibc-2.4-shim.so ${OPTDIR}/bin/${ENGINE_SCRIPT} start"</code></div><div class="line number191 index190 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">else</code></div><div class="line number192 index191 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"${OPTDIR}/bin/${ENGINE_SCRIPT} start"</code></div><div class="line number193 index192 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number194 index193 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">else</code></div><div class="line number195 index194 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"${OPTDIR}/bin/${ENGINE_SCRIPT} start"</code></div><div class="line number196 index195 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number197 index196 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number198 index197 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">;;</code></div><div class="line number199 index198 alt2">&nbsp;</div><div class="line number200 index199 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">stop)</code></div><div class="line number201 index200 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">su</code> <code class="bash plain">- ${DAEMON_USER} -s </code><code class="bash plain">/bin/sh</code> <code class="bash plain">-c </code><code class="bash string">"${OPTDIR}/bin/${ENGINE_SCRIPT} stop"</code></div><div class="line number202 index201 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ </code><code class="bash string">"${CRON_LAUNCHED}"</code> <code class="bash plain">== </code><code class="bash string">"True"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number203 index202 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">[ -e </code><code class="bash plain">/var/packages/</code><code class="bash plain">${SYNOPKG_PKGNAME}</code><code class="bash plain">/enabled</code> <code class="bash plain">] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">/var/packages/</code><code class="bash plain">${SYNOPKG_PKGNAME}</code><code class="bash plain">/enabled</code></div><div class="line number204 index203 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number205 index204 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number206 index205 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">;;</code></div><div class="line number207 index206 alt2">&nbsp;</div><div class="line number208 index207 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">status)</code></div><div class="line number209 index208 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">PID=`</code><code class="bash plain">/bin/ps</code> <code class="bash plain">w| </code><code class="bash functions">grep</code> <code class="bash string">"app=${APP_NAME}"</code> <code class="bash plain">| </code><code class="bash functions">grep</code> <code class="bash plain">-</code><code class="bash functions">v</code> <code class="bash functions">grep</code> <code class="bash plain">| </code><code class="bash functions">awk</code> <code class="bash string">'{ print $1 }'</code><code class="bash plain">`</code></div><div class="line number210 index209 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">if</code> <code class="bash plain">[ -n </code><code class="bash string">"$PID"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div><div class="line number211 index210 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number212 index211 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">else</code></div><div class="line number213 index212 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">1</code></div><div class="line number214 index213 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash keyword">fi</code></div><div class="line number215 index214 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">;;</code></div><div class="line number216 index215 alt1">&nbsp;</div><div class="line number217 index216 alt2"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">log)</code></div><div class="line number218 index217 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">echo</code> <code class="bash string">"${LOG_FILE}"</code></div><div class="line number219 index218 alt2"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash functions">exit</code> <code class="bash plain">0</code></div><div class="line number220 index219 alt1"><code class="bash spaces">&nbsp;&nbsp;</code><code class="bash plain">;;</code></div><div class="line number221 index220 alt2"><code class="bash keyword">esac</code></div></div></td></tr></tbody></table></div></div>
<div>&nbsp;</div>
<p><em>Changelog:</em></p>
<ul>
<li style="display:none;"></li>
<li>0027 Fixed open file handle limit for very large backup sets (<a href="http://support.code42.com/Administrator/3.6_And_4.0/Troubleshooting/Too_Many_Open_Files" title="Too Many Open Files" target="_blank">ulimit fix</a>)</li>
<li>0026 Updated all CrashPlan clients to version 3.6.3, improved handling of Java temp files</li>
<li>0025 glibc version shim no longer used on Intel Synology models running DSM 5.0</li>
<li>0024 Updated to CrashPlan PROe 3.6.1.4 and added support for PowerPC 2010 Synology models running DSM 5.0</li>
<li>0023 Added support for Intel Atom Evansport and Armada XP CPUs in new DSx14 products</li>
<li>0022 Updated all CrashPlan client versions to 3.5.3, compiled native binary dependencies to add support for Armada 370 CPU (DS213j), <em>start-stop-status.sh</em> now updates the new javaMemoryHeapMax value in <em>my.service.xml</em> to the value defined in <em>syno_package.vars</em></li>
<li>0021 Updated CrashPlan to version 3.5.2</li>
<li>0020 Fixes for DSM 4.2</li>
<li>018 Updated CrashPlan PRO to version 3.4.1</li>
<li>017 Updated CrashPlan and CrashPlan PROe to version 3.4.1, and improved in-app update handling</li>
<li>016 Added support for Freescale QorIQ CPUs in some x13 series Synology models, and installer script now downloads native binaries separately to reduce repo hosting bandwidth, PowerQUICC PowerPC processors in previous Synology generations with older glibc versions are not supported</li>
<li>015 Added support for easy scheduling via cron – see updated Notes section</li>
<li>014 DSM 4.1 user profile permissions fix</li>
<li>013 implemented update handling for future automatic updates from Code 42, and incremented CrashPlanPRO client to release version 3.2.1</li>
<li>012 incremented CrashPlanPROe client to release version 3.3</li>
<li>011 minor fix to allow a wildcard on the cpio archive name inside the main installer package (to fix CP PROe client since Code 42 Software had amended the cpio file version to 3.2.1.2)</li>
<li>010 minor bug fix relating to daemon home directory path</li>
<li>009 rewrote the scripts to be even easier to maintain and unified as much as possible with my imminent CrashPlan PROe server package, fixed a timezone bug (tightened regex matching), moved the script-amending logic from <em>installer.sh</em> to <em>start-stop-status.sh</em> with it now applying to all <em>.sh</em> scripts each startup so perhaps updates from Code42 might work in future, if <em>wget</em> fails to fetch the installer from Code42 the installer will look for the file in the public shared folder</li>
<li>008 merged the 14 package scripts each (7 for ARM, 7 for Intel) for CP, CP PRO, &amp; CP PROe – 42 scripts in total – down to just two! ARM &amp; Intel are now supported by the same package, Intel synos now have working inotify support (Real-Time Backup) thanks to <a href="https://github.com/wojo/synology-x86-glibc-2.4-shim">rwojo’s shim to pass the glibc version check</a>, upgrade process now retains login, cache and log data (no more re-scanning), users can specify a persistent larger max heap size for very large backup sets</li>
<li>007 fixed a bug that broke CrashPlan if the Java folder moved (if you changed version)</li>
<li>006 installation now fails without User Home service enabled, fixed Daylight Saving Time support, automated replacing the ARM <em>libffi.so</em> symlink which is destroyed by DSM upgrades, stopped assuming the primary storage volume is <em>/volume1</em>, reset ownership on <em>/var/lib/crashplan</em> and the Friends backup location after installs and upgrades</li>
<li>005 added warning to restart daemon after 1st run, and improved upgrade process again</li>
<li>004 updated to CrashPlan 3.2.1 and improved package upgrade process, forced binding to 0.0.0.0 each startup</li>
<li>003 fixed ownership of <em>/volume1/crashplan</em> folder</li>
<li>002 updated to CrashPlan 3.2</li>
<li>001 intial public release</li>
</ul>
<div>&nbsp;</div>
<div>&nbsp;</div>

<div class="wpa" style="position: relative; width:300px; text-align: center; padding: 0; margin: 10px auto; overflow: hidden; clear: both;">
<a style="position: absolute; text-align: left; display: block; font: 9px/1 sans-serif; text-decoration: underline;" href="http://en.wordpress.com/about-these-ads/" rel="nofollow">About these ads</a>
</div>
<style type="text/css">
div.wpa>div { margin-top: 1em; } #google_ads_div_wpcom_below_post_adsafe_ad_container { display: block !important; }
</style>
<script type="text/javascript">
jQuery( window ).load( function() {
    if ( jQuery(".wpa script[src*='virool.com']").length > 0 || jQuery(".wpa script[src*='shareth.ru']").length > 0 || jQuery(".wpa iframe[src*='boomvideo.tv']").length > 0 || jQuery(".wpa iframe[src*='viewablemedia.net']").length > 0 || jQuery(".wpa .sharethrough-placement").length > 0 ) {
        jQuery( '.wpa' ).css( 'width', '400px' );
    }
setTimeout(function(){if(typeof GS_googleAddAdSenseService !== 'function'){new Image().src=document.location.protocol+"//stats.wordpress.com/g.gif?v=wpcom-no-pv&x_noads=adblock&baba="+Math.random()}},100);
} );
</script>
<div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><ul><li class="share-twitter"><a rel="nofollow" class="share-twitter sd-button share-icon" href="http://pcloadletter.co.uk/2012/01/30/crashplan-syno-package/?share=twitter&amp;nb=1" title="Click to share on Twitter" id="sharing-twitter-2845"><span>Twitter</span></a></li><li class="share-facebook"><a rel="nofollow" class="share-facebook sd-button share-icon" href="http://pcloadletter.co.uk/2012/01/30/crashplan-syno-package/?share=facebook&amp;nb=1" title="Share on Facebook" id="sharing-facebook-2845"><span>Facebook</span></a></li><li class="share-end"></li></ul></div></div></div><div class="sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-loaded" id="like-post-wrapper-13693420-2845-53b01e461ebc5" data-src="//widgets.wp.com/likes/#blog_id=13693420&amp;post_id=2845&amp;origin=glassofdutchwine.wordpress.com&amp;obj_id=13693420-2845-53b01e461ebc5" data-name="like-post-frame-13693420-2845-53b01e461ebc5"><h3 class="sd-title">Like this:</h3><div class="likes-widget-placeholder post-likes-widget-placeholder" style="height: 55px; display: none;"><span class="button"><span>Like</span></span> <span class="loading">Loading...</span></div><iframe class="post-likes-widget jetpack-likes-widget" name="like-post-frame-13693420-2845-53b01e461ebc5" height="55px" width="100%" frameborder="0" src="//widgets.wp.com/likes/#blog_id=13693420&amp;post_id=2845&amp;origin=glassofdutchwine.wordpress.com&amp;obj_id=13693420-2845-53b01e461ebc5"></iframe><span class="sd-text-color"></span><a class="sd-link-color"></a></div>
<div id="jp-relatedposts" class="jp-relatedposts" style="display: block;">
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
<div class="jp-relatedposts-items jp-relatedposts-items-minimal"><p class="jp-relatedposts-post jp-relatedposts-post0" data-post-id="3259" data-post-format="false"><span class="jp-relatedposts-post-title"><a class="jp-relatedposts-post-a" href="http://pcloadletter.co.uk/2012/05/31/crashplan-proe-server-synology/" title="CrashPlan PROe Server package for Synology NAS

CrashPlan is a popular online backup solution, with most people using it to protect their data in the Cloud. However, by licensing CrashPlan PROe server you can be that Cloud&amp;hellip;" rel="nofollow" data-origin="2845" data-position="0">CrashPlan PROe Server package for Synology NAS</a></span><span class="jp-relatedposts-post-context">In "Linux"</span></p><p class="jp-relatedposts-post jp-relatedposts-post1" data-post-id="3401" data-post-format="false"><span class="jp-relatedposts-post-title"><a class="jp-relatedposts-post-a" href="http://pcloadletter.co.uk/2012/07/27/synology-nas-for-sme-workloads/" title="Synology NAS for SME workloads - my design decisions

Background It all started last year with a humble single drive DS111 which I bought for home, speculating that I could probably run Serviio on it to stream my movies&amp;hellip;" rel="nofollow" data-origin="2845" data-position="1">Synology NAS for SME workloads - my design decisions</a></span><span class="jp-relatedposts-post-context">In "VMware"</span></p><p class="jp-relatedposts-post jp-relatedposts-post2" data-post-id="2630" data-post-format="false"><span class="jp-relatedposts-post-title"><a class="jp-relatedposts-post-a" href="http://pcloadletter.co.uk/2012/01/11/minecraft-package-for-synology/" title="Minecraft package for Synology NAS

UPDATE - The instructions and notes on this page apply to both the Minecraft and the CraftBukkit packages hosted on my repo. Now works on QorIQ CPU Synology models! Minecraft&amp;hellip;" rel="nofollow" data-origin="2845" data-position="2">Minecraft package for Synology NAS</a></span><span class="jp-relatedposts-post-context">In "Linux"</span></p></div></div></div>					</div>
